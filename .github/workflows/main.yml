name: Deploy Responsive Framework

on:
  push:
    branches:
      - main
  create:
    tags:
      - '*'

jobs:
  validate:
    uses: ./.github/workflows/eoa.yml
    secrets: inherit
   
  deploy:
    needs: validate
    runs-on: ubuntu-latest

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    # Specify runner + deployment step
    steps:
      - name: ðŸ“„ Checkout
        uses: actions/checkout@v5
        with:
          lfs: true
      - name: ðŸ”¨ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
      - name: ðŸ”¨ Create html gallery
        run: npm run gallery
        working-directory: ./emailonacid
      - name: ðŸ“¦ Publish html gallery for GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with: 
          path: output
      - name: ðŸš€ Deploy html gallery to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: ðŸ”– Set VERSION variable from tag
        id: version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Extract major and minor and use run number for versioning unique vsix
          MAJOR=$(echo ${{ github.ref_name }} | sed -E 's/.*v([[:digit:]]+)\.[[:digit:]]+.*/\1/')
          MINOR=$(echo ${{ github.ref_name }} | sed -E 's/.*v[[:digit:]]+\.([[:digit:]]+).*/\1/')
          PATCH=${{ github.run_number }}
          echo "VERSION=$MAJOR.$MINOR.$PATCH" >> $GITHUB_ENV
  
          # Assume prerelease if existing release is marked as such, or tag contains hyphen
          # This allows us to create prerelease by either pushing prerelease tags or
          # creating an actual prerelease in GitHub
          IS_PRERELEASE=$(gh release view ${{ github.ref_name }} --json isPrerelease --jq '.isPrerelease' || echo '')
          if [[ $IS_PRERELEASE == 'true' || '${{ github.ref_name }}' == *'-'* ]]; then
            echo "RELEASE_ARGS=-p" >> $GITHUB_ENV
            echo "RELEASE_SUFFIX=-dev" >> $GITHUB_ENV
          else
            echo "RELEASE_ARGS=" >> $GITHUB_ENV
            echo "RELEASE_SUFFIX=" >> $GITHUB_ENV
          fi
  
          echo "EXISTING_RELEASE=$(gh release view ${{ github.ref_name }} --json name --jq '.name' || echo '')" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ github.TOKEN }}
      - name: ðŸš€ Create release
        if: ( steps.version.outcome == 'success' ) && ( env.EXISTING_RELEASE != github.ref_name )
        run: |
          gh release create v$VERSION --generate-notes $RELEASE_ARGS
        env:
          GITHUB_TOKEN: ${{ github.TOKEN }}
      - name: ðŸš€ Upload release files
        if: steps.version.outcome == 'success'
        run: gh release upload ${{ github.ref_name }} source/latest.html output
        env:
          GITHUB_TOKEN: ${{ github.TOKEN }}
