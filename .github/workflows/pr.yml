name: Validate Pull Request

on:
  pull_request:

jobs:
  validate:
    uses: ./.github/workflows/eoa.yml
    secrets:
      EOA_ACCOUNT_PASSWORD: ${{ secrets.EOA_ACCOUNT_PASSWORD }}
    with:
      EOA_API_KEY: ${{ vars.EOA_API_KEY }}
      mode: 'artifact'

  diff:
    needs: validate
    name: Create screenshot diffs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
      - name: Screenshot baseline
        run: cp -R output diff/base
      - name: Download screenshot artifacts
        uses: actions/download-artifact@v4
        with:
          name: screenshots
          path: diff/compare
      - name: Install dependencies
        run: npm ci
        working-directory: ./emailonacid
      - name: Compare screenshots
        run: npm run diff
        working-directory: ./emailonacid
      - name: Generate report screenshots
        run: npm run report-ci
        working-directory: ./emailonacid
      - name: Publish diff report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: diff
          path: diff
